# Драйверы ядра

## Обзор

Драйверы ядра обеспечивают взаимодействие с аппаратным обеспечением и предоставляют высокоуровневые интерфейсы для остальных компонентов системы.

## Системный таймер (PIT)

### Описание

Программируемый интервальный таймер (PIT) обеспечивает:
- Генерацию системных прерываний с заданной частотой
- Подсчет системных тиков
- Функции задержки и измерения времени
- Основу для многозадачности

### API

```c
// Инициализация
void pit_init(void);

// Получение информации
uint32_t pit_get_ticks(void);
uint32_t pit_get_time_ms(void);
uint32_t pit_get_frequency(void);

// Функции задержки
void pit_sleep_ms(uint32_t ms);
void pit_sleep_ticks(uint32_t ticks);

// Настройка частоты
void pit_set_frequency(uint32_t frequency);

// Диагностика
void pit_dump_info(void);
```

### Использование

```c
// Инициализация
pit_init();

// Задержка на 1 секунду
pit_sleep_ms(1000);

// Получение времени с момента загрузки
uint32_t uptime = pit_get_time_ms();

// Изменение частоты таймера
pit_set_frequency(50); // 50 Гц
```

## Драйвер клавиатуры

### Описание

Драйвер клавиатуры PS/2 обеспечивает:
- Обработку нажатий клавиш
- Поддержку модификаторов (Shift, Caps Lock)
- Буферизацию ввода
- Управление светодиодами

### API

```c
// Инициализация
void keyboard_init(void);

// Чтение ввода
char keyboard_read(void);
char* read_line(unsigned int max_length);
```

### Использование

```c
// Инициализация
keyboard_init();

// Чтение строки
char* input = read_line(256);
if (input) {
    // Обработка ввода
    kfree(input); // Освобождение памяти
}
```

## Архитектура драйверов

### Прерывания

Все драйверы используют механизм прерываний для асинхронной обработки событий:

- **PIT**: IRQ0 (прерывание системного таймера)
- **Клавиатура**: IRQ1 (прерывание клавиатуры)

### Обработчики прерываний

```c
// Обработчик прерывания PIT
void pit_handler(void);

// Обработчик прерывания клавиатуры
void keyboard_handler_main(void);
```

### Энергосбережение

Драйверы используют инструкцию `hlt` для экономии энергии:

```c
// Вместо активного ожидания
while (!condition) {
    // Бесполезная работа
}

// Используем hlt
while (!condition) {
    __asm__ volatile("hlt");
}
```

## Преимущества реализации

1. **Эффективность**: Использование прерываний вместо опроса
2. **Энергосбережение**: Инструкция `hlt` в циклах ожидания
3. **Масштабируемость**: Легко добавлять новые драйверы
4. **Надежность**: Обработка ошибок и проверки
5. **Отладка**: Подробная диагностическая информация

## Тестирование

Включены автоматические тесты для всех драйверов:

```c
// Тесты таймера
run_timer_tests();

// Тесты клавиатуры (встроены в основной цикл)
```

## Зависимости

- `video.h` - для вывода диагностической информации
- `idt.h` - для работы с прерываниями
- `memory.h` - для динамического выделения памяти 