/**
 * @file video.c
 * @brief Реализация функций для работы с видеопамятью в текстовом режиме VGA
 * 
 * Этот модуль предоставляет базовые функции для вывода текста на экран
 * в текстовом режиме 80x25 символов. Работает напрямую с видеопамятью
 * по адресу 0xB8000.
 */

#include "video.h"

/**
 * @brief Адрес видеопамяти в текстовом режиме VGA
 * 
 * Каждый символ на экране представлен двумя байтами:
 * - Младший байт: ASCII-код символа
 * - Старший байт: атрибуты символа (цвета переднего плана и фона)
 */
#define VIDEO_MEMORY ((char*)0xB8000)

/**
 * @brief Размер видеопамяти в текстовом режиме 80x25
 * 
 * Рассчитывается как: 80 символов * 25 строк * 2 байта на символ
 */
#define SCREEN_SIZE (80 * 25 * 2)

/**
 * @brief Очищает экран, заполняя его пробелами
 * 
 * Функция проходит по всей видеопамяти и устанавливает:
 * - В четные ячейки: ASCII-код пробела (0x20)
 * - В нечетные ячейки: атрибут символа (0x07 - светло-серый на черном фоне)
 * 
 * @note Атрибут 0x07 означает:
 *       - Биты 0-2: цвет текста (7 - светло-серый)
 *       - Бит 3: интенсивность (0 - обычная)
 *       - Биты 4-6: цвет фона (0 - черный)
 *       - Бит 7: мигание (0 - выключено)
 */
void clear_screen(void) 
{
    // Проходим по всей видеопамяти с шагом 2 байта (символ + атрибут)
    for (unsigned i = 0; i < SCREEN_SIZE; i += 2) {
        VIDEO_MEMORY[i] = ' ';      // Записываем пробел в позицию символа
        VIDEO_MEMORY[i+1] = 0x07;   // Устанавливаем атрибуты символа
    }
}

/**
 * @brief Выводит строку на экран в текущей позиции
 * 
 * Функция выводит строку ASCIIZ (завершающуюся нулем) в видеопамять,
 * начиная с левого верхнего угла экрана. Каждый символ выводится
 * с атрибутом 0x07 (светло-серый на черном фоне).
 * 
 * @param str Указатель на строку для вывода (должна завершаться нулем)
 * 
 * @note Функция не проверяет выход за границы экрана.
 * @note Для переноса строки и других специальных символов требуется
 *       дополнительная обработка. Написано ведь еще так мало, но скоро у меня поедет крыша
 */
void print_string(const char* str) 
{
    // Позиция в видеопамяти (0 - левый верхний угол экрана)
    unsigned pos = 0;
    
    // Пока не встретим нулевой символ (конец строки)
    while (*str) {
        // Записываем текущий символ строки в видеопамять
        VIDEO_MEMORY[pos] = *str++;
        
        // Устанавливаем атрибуты символа (0x07 - стандартный)
        VIDEO_MEMORY[pos+1] = 0x07;
        
        // Переходим к следующей позиции (2 байта на символ)
        pos += 2;
    }
}

void print_string_color(const char* str, unsigned char fg_color, unsigned char bg_color) 
{
    unsigned pos = 0;
    unsigned char attribute = (bg_color << 4) | (fg_color & 0x0F);
    
    while (*str) {
        VIDEO_MEMORY[pos] = *str++;
        VIDEO_MEMORY[pos+1] = attribute;
        pos += 2;
    }
}